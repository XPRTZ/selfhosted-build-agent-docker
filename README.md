# Self-hosted build agent voor Azure DevOps met Docker

Azure DevOps is voor ons de belangrijkste service om werk te plannen, samen te programmeren en de applicaties te bouwen en te deployen. Om deze applicaties te builden heeft Microsoft gratis resources beschikbaar gesteld, per maand kan je gebruikmaken van 1800 minuten om je applicaties te builden. Dat lijkt veel maar eens je volledig inzet op het continuous integration/continuous deployment (CI/CD) principe dan verdwijnen deze minuten als snel als sneeuw voor de zon. Omdat we uiteraard goede principes zoals CI/CD niet graag opzij zetten om build minuten te sparen geven we hieronder een overzicht wat de opties zijn om zowel CI/CD te ontwikkelen en toch de kosten wat in de hand te houden.

Er zijn eigenlijk twee opties: je koopt extra resources bij Microsoft of je richt zelf een build agent in om onbeperkt je code te kunnen builden. De pricing van Microsoft kan soms redelijk onoverzichtelijk overkomen dus daarom een korte samenvatting. Microsoft maakt een onderscheid tussen Private projects en Public projects. Het draait bij beide opties voornamelijk om de parallelle builds die je kan uitvoeren. Om te beginnen met de Private projects, dat is toch nog wat bij grote klanten het meeste voorkomt. Je krijgt de mogelijkheid om gebruik te maken van de Microsoft-hosted build agent voor 1800 minuten en 1 parallelle build. Daarnaast mag je 1 self-hosted build agent met een onbeperkt aantal minuten toevoegen aan het project. Hebben de gebruikers van je project een Visual Studio Enterprise licentie dan heb je de mogelijkheid om per gebruiker 1 self-hosted build agent toe te voegen. Public projects hebben een ruimere marge: die krijgen van Microsoft 10 parallelle builds met een onbeperkt aantal minuten en ook gelijk de mogelijkheid om een onbeperkt aantal self-hosted agents toe te voegen.

Bijvoorbeeld, ik heb een private project met 3 gebruikers en 2 van deze gebruikers hebben een Visual Studio Enterprise licentie, de derde heeft een Visual Studio Professional licentie. Wat ik maximaal tot mijn beschikking heb zonder bij te betalen is het volgende:

|Soort|Aantal|Aantal minuten|
|----------|----------|----------|
|Microsoft-hosted|1|1800|
|Self-hosted|2|Onbeperkt|

Er kunnen dus 3 builds tegelijk uitgevoerd worden, tot de 1800 minuten van de Microsoft-hosted build agent op zijn, dan vallen we terug op 2 parallelle builds.

Waarom zijn de parallelle builds zo belangrijk? Zeker met het CI principe wil je iedere developer de mogelijkheid geven om te kijken of zijn code wel build op de build agents. Parallelle builds zie je ook terug bij het gebruik van pull requests (PR), we willen dat er eerst een succesvolle build wordt afgerond vooraleer de code gemerged kan worden naar master. Stel, je build duurt 10 minuten -wat niet heel gek is- en je bent met 3 developers met een Visual Studio Enterprice licentie. Je hebt niet van de mogelijkheid gebruik gemaakt om self-hosted build agents toe te voegen, je hebt alleen de Microsoft-hosted build agent en deze wel uitgebreid dat er na de 1800 gratis minuten betaald voor wordt zodat er steeds gebuild kan worden, dat kost je net je geen 34 EUR/maand. Elke developer gaat een PR aanmaken, de eerste developer heeft geluk, zijn PR begint meteen met builden. Na ongeveer 6 minuten maakt developer #2 een PR aan. Er moet nu nog 4 minuten worden gewacht vooraleer de build wordt gestart. Nog eens 5 minuten later maakt developer #3 een PR aan, hij maakt maar een kleine wijziging. De build van developer #2 duurt nog 9 minuten vooraleer de build van developer #3 begint. Ondertussen is de build van developer #1 afgelopen en geslaagd en hij wil zijn code nu doortzetten naar de master branch. Hierdoor wordt de build van developer #2 die ondertussen ook afgelopen is als niet geldig aangemerkt omdat de code op master is gewijzigd, er moet opnieuw worden geintegreerd vooraleer de code van developer #2 naar master kan worden doorgezet...

Je merkt het al, de tijd die het duurt stapelt zich op en werkt in het nadeel van de productiviteit van de developers. De oplossing is eigenlijk simpel, als iedere developer gebruik maakt van de mogelijkheid om een self-hosted build toe te voegen, worden de wachttijden enorm verkort. 